#' Plot Genome Tracks for a Genomic Region
#'
#' Generates a genome browser-style plot using Gviz tracks, including ideogram, axis, transcript, and custom
#' data/control tracks from BigWig or BED files.
#'
#' @param genome_axis_track A `Gviz::GenomeAxisTrack` object for coordinate axis.
#' @param ideogram_track_list A named list of `Gviz::IdeogramTrack` objects, keyed by chromosome.
#' @param transcript_track A `Gviz::GeneRegionTrack` or `Gviz::AnnotationTrack` with transcript annotations.
#' @param chromosome Chromosome to plot (e.g., "chr1").
#' @param start Genomic start coordinate.
#' @param end Genomic end coordinate.
#' @param parameters A `data.frame` describing sample and control tracks with columns:
#'   \describe{
#'     \item{SampleLabel}{Track label for sample.}
#'     \item{SampleFilename}{Path to BigWig or BED file for sample.}
#'     \item{SampleColor}{Color for sample track.}
#'     \item{ControlLabel}{Track label for control.}
#'     \item{ControlFilename}{Path to BigWig file for control.}
#'     \item{ControlColor}{Color for control track.}
#'   }
#' @param sample_label Vector of sample labels to include in the plot.
#' @param sample_labels Optional vector used for calculating y-axis limits. Defaults to `sample_label`.
#' If `NULL`, it will be set to the value of `sample_label`.
#' @param relative_line_width_genome_axis Line width for genome axis track.
#' @param relative_line_width_hist Line width for histogram tracks.
#' @param genome_axis_font_size Font size for axis labels.
#' @param label_font_scale Scaling factor for all track titles.
#' @param ideogram_marker_size Line width for ideogram marker lines.
#'
#' @return A genome track plot generated by `Gviz::plotTracks()`.
#' @export
#'
#' @import GenomicRanges IRanges Gviz rtracklayer
#' @importFrom utils head tail
make_genome_track_plot <- function(
  genome_axis_track,
  ideogram_track_list,
  transcript_track,
  chromosome,
  start,
  end,
  parameters,
  sample_label,
  sample_labels = NULL,
  relative_line_width_genome_axis = 1L,
  relative_line_width_hist = 1L,
  genome_axis_font_size = 6L,
  label_font_scale = 0.7,
  ideogram_marker_size = 3L
) {
  options(ucscChromosomeNames = FALSE)

  if (is.null(sample_labels)) {
    sample_labels <- sample_label
  }

  region_gr <- GenomicRanges::GRanges(
    seqnames = chromosome,
    ranges = IRanges::IRanges(start = start, end = end)
  )
  region_selection <- rtracklayer::BigWigSelection(region_gr)

  parameters$SampleFilename <- as.character(parameters$SampleFilename)
  parameters$ControlFilename <- as.character(parameters$ControlFilename)

  bigwig_params <- parameters[grep(".bw$", parameters$SampleFilename, ignore.case = TRUE), ]
  bed_params <- parameters[grep(".bed$", parameters$SampleFilename, ignore.case = TRUE), ]

  sample_bw_files <- lapply(bigwig_params$SampleFilename, rtracklayer::import.bw, selection = region_selection)
  names(sample_bw_files) <- bigwig_params$SampleLabel

  control_bw_files <- lapply(bigwig_params$ControlFilename, rtracklayer::import.bw, selection = region_selection)
  names(control_bw_files) <- bigwig_params$SampleLabel

  parameters$yMaxs <- sapply(sample_labels, function(lbl) {
    round(max(c(sample_bw_files[[lbl]]$score, control_bw_files[[lbl]]$score)), 0)
  })

  parameters$yMins <- sapply(sample_labels, function(lbl) {
    round(min(c(sample_bw_files[[lbl]]$score, control_bw_files[[lbl]]$score)), 0)
  })

  sample_bed_files <- lapply(bed_params$SampleFilename, function(file) {
    gr <- rtracklayer::import.bed(file)
    GenomicRanges::strand(gr) <- "*"
    IRanges::subsetByOverlaps(gr, region_gr)
  })
  names(sample_bed_files) <- bed_params$SampleLabel

  sample_data_tracks <- lapply(parameters$SampleLabel, function(lbl) {
    row <- parameters[parameters$SampleLabel == lbl, ]
    if (grepl(".bw$", row$SampleFilename, ignore.case = TRUE)) {
      Gviz::OverlayTrack(
        trackList = list(
          Gviz::DataTrack(
            range = sample_bw_files[[row$SampleLabel]],
            genome = "hg38",
            type = "hist",
            col = row$SampleColor,
            col.histogram = row$SampleColor,
            fill.histogram = row$SampleColor,
            ylim = c(row$yMins, row$yMaxs),
            lwd = relative_line_width_hist,
            legend = TRUE,
            name = row$SampleLabel,
            showAxis = FALSE,
            background.title = "blue",
            cex.title = label_font_scale,
            showTitle = FALSE
          ),
          Gviz::DataTrack(
            range = control_bw_files[[row$SampleLabel]],
            genome = "hg38",
            type = "hist",
            col = row$ControlColor,
            col.histogram = row$ControlColor,
            fill.histogram = row$ControlColor,
            ylim = c(row$yMins, row$yMaxs),
            lwd = relative_line_width_hist,
            legend = TRUE,
            name = row$ControlLabel,
            showAxis = FALSE,
            background.title = "blue",
            cex.title = label_font_scale,
            showTitle = FALSE
          )
        ),
        name = row$SampleLabel,
        background.title = "transparent",
        cex.title = label_font_scale
      )
    } else {
      Gviz::AnnotationTrack(
        range = sample_bed_files[[row$SampleLabel]],
        name = row$SampleLabel,
        col = row$SampleColor,
        fill = row$SampleColor,
        col.line = row$SampleColor,
        background.title = "transparent",
        cex.title = label_font_scale,
        showTitle = FALSE
      )
    }
  })

  ideogram_track <- ideogram_track_list[[chromosome]]

  Gviz::displayPars(genome_axis_track)$lwd <- relative_line_width_genome_axis
  Gviz::displayPars(genome_axis_track)$fontsize <- genome_axis_font_size
  Gviz::displayPars(genome_axis_track)$cex.title <- label_font_scale
  Gviz::displayPars(ideogram_track)$lwd <- ideogram_marker_size
  Gviz::displayPars(ideogram_track)$cex.title <- label_font_scale
  Gviz::displayPars(transcript_track)$cex.title <- label_font_scale

  track_list <- list(ideogram_track, transcript_track, genome_axis_track)

  Gviz::plotTracks(
    c(track_list[[1]], sample_data_tracks, track_list[[2]], track_list[[3]]),
    from = start,
    to = end
  )
}

